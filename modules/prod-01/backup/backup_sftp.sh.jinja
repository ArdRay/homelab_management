#!/bin/bash

export B2_ACCOUNT_ID={{ pillar['backups']['services']['b2']['account_id'] }}
export B2_ACCOUNT_KEY={{ pillar['backups']['services']['b2']['account_key'] }}
export RESTIC_PASSWORD_COMMAND="echo -n {{ pillar['backups']['services']['repository']['password'] }}"

# If repo is not initialised, create 
/usr/local/bin/restic -r {{ pillar['backups']['services']['repository']['name'] }}:sftp snapshots || /usr/local/bin/restic -r {{ pillar['backups']['services']['repository']['name'] }}:sftp init

/usr/local/bin/restic -r {{ pillar['backups']['services']['repository']['name'] }}:sftp backup --tag sftp /data/sftp/lexmark

curl -m 10 --retry 5 https://healthcheck.ts.vcu.edu/ping/{{ pillar['healthchecks']['services']['sftp'] }}/